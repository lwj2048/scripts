name: Actions (testcache)
on:
  workflow_dispatch:

jobs:
  test-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10.9'

      - name: æ£€æŸ¥ç³»ç»Ÿä¿¡æ¯
        run: |
          echo "ï¿½ï¿½ ç³»ç»Ÿä¿¡æ¯ï¼š"
          uname -a
          lsb_release -a
          df -h
          mkdir -p /home/runner/work1/1234
          mkdir -p /home/runner/work2
          touch /home/runner/work1/1234/456.txt

      - name: Test Save Cache (without ci_path)
        uses: lwj-st/cache/save@v4.2.4
        with:
          path: '1234'
          key: 'lwj5'
          ci_path: '/home/runner/work1/'  


      - name: Test Restore Cache (with ci_path)
        uses: lwj-st/cache/restore@v4.2.4
        with:
          path: '1234'  # ç›¸å¯¹è·¯å¾„ï¼Œå› ä¸ºä¼šåˆ‡æ¢åˆ° test-ci-dir
          key: 'lwj7'
          ci_path: '/home/runner/work2/' 

      - name: which 
        run: |
          pwd
          ls /home/runner/work2
          echo "--------------------------------------------"
          ls /home/runner/work2/1234

      - name: Test Save Cache 8
        uses: lwj-st/cache/save@v4.2.4
        with:
          path: '12345'
          key: 'lwj8'
          ci_path: '/home/runner/work1/' 

      - name: Test Save Cache 9
        uses: lwj-st/cache/save@v4.2.4
        with:
          path: '1234'
          key: 'lwj9'
          ci_path: '/home/runner/work3/' 

      - name: Test restore Cache 9
        uses: lwj-st/cache/restore@v4.2.4
        with:
          path: '1234'
          key: 'lwj9'
          ci_path: '/home/runner/work3/' 

      - name: Test Save Cache 10
        uses: lwj-st/cache/save@v4.2.4
        with:
          path: 'shell'
          key: 'lwj10'

      - name: Test Restore Cache 10
        uses: lwj-st/cache/restore@v4.2.4
        with:
          path: 'shell'  # ç›¸å¯¹è·¯å¾„ï¼Œå› ä¸ºä¼šåˆ‡æ¢åˆ° test-ci-dir
          key: 'lwj10'
          ci_path: '/home/runner/work2/' 

      - name: which 10
        run: |
          pwd
          ls /home/runner/work2
          echo "--------------------------------------------"
          ls /home/runner/work2/shell

      - name: å®‰è£… SSH æœåŠ¡
        uses: ./.github/actions/install-ssh
        with:
          platform: 'ubuntu'
          public_key: ${{ secrets.ID_RSA_PUB }}


      - name: å®‰è£… ngrok å¹¶æš´éœ²ç«¯å£
        uses: ./.github/actions/ngrok-ssh
        with:
          platform: 'ubuntu'
          auth_token: ${{ secrets.NGROK_AUTH_TOKEN }}
          port: '22'
          protocol: 'tcp'

      - name: è·å–è®¿é—®åœ°å€
        run: |
          pwd
          ls /home/runner/work2
          echo "--------------------------------------------"
          ls /home/runner/work2/1234
          sleep 5
          # è·å– ngrok åœ°å€
          if curl -s http://127.0.0.1:4040/api/tunnels > /dev/null 2>&1; then
            curl -s http://127.0.0.1:4040/api/tunnels | jq -r '.tunnels[0].public_url' > ssh_address.txt
            echo "ğŸ”¹ ngrok SSH åœ°å€ï¼š" $(cat ssh_address.txt)
          fi
          
          # æ£€æŸ¥ cloudflared çŠ¶æ€
          if [ -f "cloudflared.log" ]; then
            echo "ï¿½ï¿½ Cloudflared éš§é“å·²å¯åŠ¨ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—è·å–è¿æ¥ä¿¡æ¯"
            tail -n 5 cloudflared.log
          fi

      - name: è¾“å‡ºè¿æ¥ä¿¡æ¯
        run: |
          echo "ğŸ”¹ æµ‹è¯•å®Œæˆï¼"
          echo "ğŸ”¹ å¯ç”¨çš„æŒ‚è½½ç‚¹ï¼š"
          echo "   - Google Drive: /mnt/google-drive"
          echo "   - Koofr: /mnt/share"
          echo "ğŸ”¹ å¯ç”¨çš„éš§é“æœåŠ¡ï¼š"
          if [ -f "ssh_address.txt" ]; then
            SSH_HOST=$(cat ssh_address.txt | sed -E 's#tcp://([^:]+):([0-9]+)#\1#')
            SSH_PORT=$(cat ssh_address.txt | sed -E 's#tcp://([^:]+):([0-9]+)#\2#')
            echo "   - ngrok SSH: ssh root@${SSH_HOST} -p ${SSH_PORT}"
          fi
          echo "   - Cloudflared: è¯·æŸ¥çœ‹ cloudflared.log è·å–è¿æ¥ä¿¡æ¯"
          sleep 5h 
