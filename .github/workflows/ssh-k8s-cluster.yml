name: SSH k8s cluster

on:
  workflow_dispatch:  

jobs:
  start-k8s-cluster:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10.9'

      - name: æ‰©å¤§ç©ºé—´
        uses: ./.github/actions/expand-space
        with:
          platform: 'ubuntu'

      - name: å®‰è£… SSH æœåŠ¡
        uses: ./.github/actions/install-ssh
        with:
          platform: 'ubuntu'
          public_key: ${{ secrets.ID_RSA_PUB }}

      - name: æŒ‚è½½ Koofr WebDAV (davfs2)
        uses: ./.github/actions/davfs2-mount
        with:
          platform: 'ubuntu'
          webdav_url: 'https://app.koofr.net/dav/Koofr/'
          username: ${{ secrets.KOOFR_USERNAME }}
          password: ${{ secrets.KOOFR_PASSWORD }}
          mount_point: '/mnt/share'

      - name: å®‰è£… ngrok å¹¶æš´éœ²ç«¯å£
        uses: ./.github/actions/ngrok-ssh
        with:
          platform: 'ubuntu'
          auth_token: ${{ secrets.NGROK_AUTH_TOKEN }}
          port: '22'
          protocol: 'tcp'
          
      - name : login docker hub   
        run: echo "${{ secrets.DOCKER_ACCESS_TOKEN }}" | sudo docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      - name : å®‰è£…k8s
        run: |
          sudo apt update
          sudo apt install socat conntrack -y
          sudo bash ./shell/install/install_k8s.sh

      - name : ç›‘æ§localhostç«¯å£
        run: |
          sudo nohup kubectl port-forward svc/ks-console -n kubesphere-system 30880:80 > portforward.log 2>&1 &
          
      - name: å®‰è£… Cloudflared éš§é“
        uses: ./.github/actions/cloudflared-tunnel
        with:
          platform: 'ubuntu'
          tunnel_token: ${{ secrets.CLOUDFLARE_TUNNEL_KUBESPHERE_TOKEN }}
          log_file: 'cloudflared.log'
          
      - name: è·å– SSH è®¿é—®åœ°å€
        run: |
          sleep 5
          curl -s http://127.0.0.1:4040/api/tunnels | jq -r '.tunnels[0].public_url' > ssh_address.txt
          echo "ğŸ”¹ ä½ çš„ SSH åœ°å€ï¼š" $(cat ssh_address.txt)

      - name: è¾“å‡º SSH è¿æ¥æ–¹å¼
        run: |
          echo "ğŸ”¹ ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¿æ¥åˆ°æœåŠ¡å™¨ï¼š"
          echo " ssh root@$(cat ssh_address.txt | sed -E 's#tcp://([^:]+):([0-9]+)#\1#') -p $(cat ssh_address.txt | sed -E 's#tcp://([^:]+):([0-9]+)#\2#') "
          sleep 5h   
