name: Linux ARM Actions

on:
  workflow_dispatch:  # 手动触发

jobs:
  test-linux-arm:
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v4
      
      - name: 检查系统信息
        run: |
          echo "�� 系统信息："
          uname -a
          lsb_release -a
          df -h
          lscpu | grep Architecture

      - name: 扩大空间
        uses: ./.github/actions/expand-space
        with:
          platform: 'ubuntu'

      - name: 安装 SSH 服务
        uses: ./.github/actions/install-ssh
        with:
          platform: 'ubuntu'
          public_key: ${{ secrets.ID_RSA_PUB }}
          username: 'root'

      - name: 挂载 Google Drive (rclone)
        uses: ./.github/actions/mount-drive
        with:
          platform: 'ubuntu'
          rclone_config: ${{ secrets.RCLONE_CONF_BASE64 }}
          mount_point: '/mnt/google-drive'
          drive_name: 'google-drive'

      - name: 挂载 Koofr WebDAV (davfs2)
        uses: ./.github/actions/davfs2-mount
        with:
          platform: 'ubuntu'
          webdav_url: 'https://app.koofr.net/dav/Koofr/'
          username: ${{ secrets.KOOFR_USERNAME }}
          password: ${{ secrets.KOOFR_PASSWORD }}
          mount_point: '/mnt/share'

      - name: 安装 ngrok 并暴露端口
        uses: ./.github/actions/ngrok-ssh
        with:
          platform: 'ubuntu'
          auth_token: ${{ secrets.NGROK_AUTH_TOKEN }}
          port: '22'
          protocol: 'tcp'

      - name: 安装 Cloudflared 隧道
        uses: ./.github/actions/cloudflared-tunnel
        with:
          platform: 'ubuntu'
          tunnel_token: ${{ secrets.CLOUDFLARE_TUNNEL_GITHUB_TOKEN }}
          log_file: 'cloudflared.log'

      - name: 验证挂载点
        run: |
          echo "🔹 挂载点状态："
          df -h | grep -E "(google-drive|share)"
          ls -la /mnt/

      - name: 获取访问地址
        run: |
          sleep 5
          # 获取 ngrok 地址
          if curl -s http://127.0.0.1:4040/api/tunnels > /dev/null 2>&1; then
            curl -s http://127.0.0.1:4040/api/tunnels | jq -r '.tunnels[0].public_url' > ssh_address.txt
            echo "🔹 ngrok SSH 地址：" $(cat ssh_address.txt)
          fi
          
          # 检查 cloudflared 状态
          if [ -f "cloudflared.log" ]; then
            echo "�� Cloudflared 隧道已启动，请查看日志获取连接信息"
            tail -n 5 cloudflared.log
          fi

      - name: 输出连接信息
        run: |
          echo "�� 测试完成！"
          echo "�� 系统架构：ARM64"
          echo "🔹 可用的挂载点："
          echo "   - Google Drive: /mnt/google-drive"
          echo "   - Koofr: /mnt/share"
          echo "🔹 可用的隧道服务："
          if [ -f "ssh_address.txt" ]; then
            SSH_HOST=$(cat ssh_address.txt | sed -E 's#tcp://([^:]+):([0-9]+)#\1#')
            SSH_PORT=$(cat ssh_address.txt | sed -E 's#tcp://([^:]+):([0-9]+)#\2#')
            echo "   - ngrok SSH: ssh root@${SSH_HOST} -p ${SSH_PORT}"
          fi
          echo "   - Cloudflared: 请查看 cloudflared.log 获取连接信息"
          sleep 5h 
