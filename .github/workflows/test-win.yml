name: Windows Actions

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘

jobs:
  test-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: æ£€æŸ¥ç³»ç»Ÿä¿¡æ¯
        run: |
          Write-Host "ğŸ”¹ ç³»ç»Ÿä¿¡æ¯ï¼š"
          Get-ComputerInfo | Select-Object WindowsProductName, WindowsVersion, TotalPhysicalMemory
          Get-WmiObject -Class Win32_LogicalDisk | Select-Object DeviceID, Size, FreeSpace

      - name: æ‰©å¤§ç©ºé—´
        uses: ./.github/actions/expand-space
        with:
          platform: 'windows'

      - name: å®‰è£… SSH æœåŠ¡
        uses: ./.github/actions/install-ssh
        with:
          platform: 'windows'
          public_key: ${{ secrets.ID_RSA_PUB }}
          username: 'runneradmin'
          password: 'Passwd123.@'

      - name: æŒ‚è½½ Google Drive (rclone)
        uses: ./.github/actions/mount-drive
        with:
          platform: 'windows'
          rclone_config: ${{ secrets.RCLONE_CONF_BASE64 }}
          mount_point: 'C:\mnt\google-drive'
          drive_name: 'google-drive'

      - name: æŒ‚è½½ Koofr WebDAV (davfs2)
        uses: ./.github/actions/davfs2-mount
        with:
          platform: 'windows'
          webdav_url: 'https://app.koofr.net/dav/Koofr/'
          username: ${{ secrets.KOOFR_USERNAME }}
          password: ${{ secrets.KOOFR_PASSWORD }}
          mount_point: 'C:\mnt\share'

      - name: å®‰è£… ngrok å¹¶æš´éœ² SSH ç«¯å£
        uses: ./.github/actions/ngrok-ssh
        with:
          platform: 'windows'
          auth_token: ${{ secrets.NGROK_AUTH_TOKEN }}
          port: '22'
          protocol: 'tcp'

      - name: å®‰è£… Cloudflared éš§é“
        uses: ./.github/actions/cloudflared-tunnel
        with:
          platform: 'windows'
          tunnel_token: ${{ secrets.CLOUDFLARE_TUNNEL_GITHUB_TOKEN }}
          log_file: 'cloudflared.log'

      - name: è·å–è®¿é—®åœ°å€
        run: |
          Start-Sleep -Seconds 5
          # è·å– ngrok åœ°å€
          try {
            $tunnels = Invoke-RestMethod -Uri "http://127.0.0.1:4040/api/tunnels" -ErrorAction SilentlyContinue
            if ($tunnels.tunnels.Count -gt 0) {
              $public_url = $tunnels.tunnels[0].public_url
              Write-Output "ğŸ”¹ ngrok SSH åœ°å€ï¼š$public_url"
              $public_url | Out-File -FilePath "ssh_address.txt" -Encoding UTF8
            }
          } catch {
            Write-Host "âŒ æ— æ³•è·å– ngrok åœ°å€"
          }
          
          # æ£€æŸ¥ cloudflared çŠ¶æ€
          if (Test-Path "cloudflared.log") {
            Write-Host "ğŸ”¹ Cloudflared éš§é“å·²å¯åŠ¨ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—è·å–è¿æ¥ä¿¡æ¯"
            Get-Content "cloudflared.log" -Tail 5
          }

      - name: è¾“å‡ºè¿æ¥ä¿¡æ¯
        run: |
          Write-Host "ğŸ”¹ å¯ç”¨çš„éš§é“æœåŠ¡ï¼š"
          if (Test-Path "ssh_address.txt") {
            $ssh_address = Get-Content "ssh_address.txt"
            $ssh_host = $ssh_address -replace "tcp://([^:]+):([0-9]+)", '$1'
            $ssh_port = $ssh_address -replace "tcp://([^:]+):([0-9]+)", '$2'
            Write-Host "   - ngrok SSH: ssh runneradmin@${ssh_host} -p ${ssh_port}  å¯†ç ï¼šPasswd123.@ "
          }
          Write-Host "   - Cloudflared: è¯·æŸ¥çœ‹ cloudflared.log è·å–è¿æ¥ä¿¡æ¯"
          Start-Sleep -Seconds 18000  
