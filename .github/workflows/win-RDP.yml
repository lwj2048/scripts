name: win RDP

on:
  workflow_dispatch:

jobs:
  expose-rdp:
    runs-on: windows-latest
    steps:
      - name: åˆ›å»ºè¿œç¨‹æ¡Œé¢ç”¨æˆ·
        shell: powershell
        run: |
          $username = "rdpuser"
          $password = "P@ssw0rd123"
          net user $username $password /add
          net localgroup "Remote Desktop Users" $username /add
          Write-Output "User $username with password $password added to Remote Desktop Users group"
      - name: å¼€å¯è¿œç¨‹æ¡Œé¢æœåŠ¡
        run: |
          # å…è®¸è¿œç¨‹æ¡Œé¢è¿æ¥
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
          # æ”¾è¡Œé˜²ç«å¢™çš„è¿œç¨‹æ¡Œé¢è§„åˆ™
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          # ç¡®è®¤å¼€å¯çŠ¶æ€
          $status = (Get-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server").fDenyTSConnections
          Write-Output "è¿œç¨‹æ¡Œé¢å¼€å¯çŠ¶æ€ï¼ˆ0ä¸ºå¼€å¯ï¼‰: $status"
          
      - name: å®‰è£… ngrok å¹¶æš´éœ² RDP ç«¯å£
        shell: powershell
        run: |
          Invoke-WebRequest -Uri "https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip" -OutFile ngrok.zip
          Expand-Archive -Path ngrok.zip -DestinationPath C:\ngrok
          C:\ngrok\ngrok.exe authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
          Start-Process -FilePath C:\ngrok\ngrok.exe -ArgumentList "tcp 3389" -NoNewWindow -PassThru
          Start-Sleep -Seconds 5
          $tunnels = Invoke-RestMethod -Uri http://127.0.0.1:4040/api/tunnels
          if ($tunnels.tunnels.Count -gt 0) {
              $public_url = $tunnels.tunnels[0].public_url
              Write-Output "ğŸ”¹ ä½ çš„ RDP åœ°å€ï¼š$public_url"
              $public_url | Out-File rdp_address.txt
          } else {
              Write-Output "âŒ è·å– ngrok å…¬å¼€åœ°å€å¤±è´¥"
          }
          # è§£æ host å’Œ port
          $rdp_address = Get-Content rdp_address.txt
          $rdp_host = $rdp_address -replace "tcp://([^:]+):([0-9]+)", '$1'
          $rdp_port = $rdp_address -replace "tcp://([^:]+):([0-9]+)", '$2'
          Write-Output "ğŸ”¹ ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¿æ¥åˆ°æœåŠ¡å™¨ï¼š"
          Write-Output "   mstsc /v:${rdp_host}:${rdp_port}"

          Write-Host "âœ… æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨..."
          net user rdpuser

          Write-Host "`nâœ… æ£€æŸ¥ç”¨æˆ·æ˜¯å¦åœ¨ Remote Desktop Users ç»„..."
          net localgroup "Remote Desktop Users"

          Write-Host "`nâœ… æ£€æŸ¥è¿œç¨‹æ¡Œé¢æ˜¯å¦å¯ç”¨ (fDenyTSConnections)..."
          Get-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections"

          Write-Host "`nâœ… æ£€æŸ¥é˜²ç«å¢™è§„åˆ™æ˜¯å¦å¯ç”¨ï¼ˆè¿œç¨‹æ¡Œé¢ï¼‰..."
          Get-NetFirewallRule -DisplayGroup "Remote Desktop" | Select Name, Enabled, Action

          Write-Host "`nâœ… æ£€æŸ¥è¿œç¨‹æ¡Œé¢æœåŠ¡ï¼ˆTermServiceï¼‰çŠ¶æ€..."
          Get-Service -Name TermService | Select Status, StartType

          Write-Host "`nâœ… æ£€æŸ¥ç›‘å¬çš„ç«¯å£..."
          netstat -an | findstr ":3389"

          Write-Host "`nâœ… æ£€æŸ¥ ngrok æ˜¯å¦æˆåŠŸå»ºç«‹éš§é“..."
          try {
            $response = Invoke-RestMethod -Uri http://127.0.0.1:4040/api/tunnels
            $response.tunnels | ForEach-Object {
              Write-Host "ğŸ”¹ Tunnel: $($_.public_url) -> $($_.config.addr)"
            }
          } catch {
            Write-Host "âŒ æ— æ³•è¿æ¥åˆ° ngrok æœ¬åœ°æ¥å£"
          }
          Start-Sleep -Seconds 21600  # ä¿æŒ 6 å°æ—¶
